# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  EhViewer Apple â€” Ad-Hoc æ„å»º & éƒ¨ç½²æµæ°´çº¿
#  è§¦å‘: main åˆ†æ”¯ push / æ‰‹åŠ¨ dispatch
#  ç›®æ ‡: RackNerd (Stellatrix.icu) â†’ itms-services å®‰è£…
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Build & Deploy iOS (Ad-Hoc)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_note:
        description: "æœ¬æ¬¡æ„å»ºå¤‡æ³¨ (ä¼šè¿½åŠ åˆ°ç‰ˆæœ¬æ ‡é¢˜)"
        required: false
        default: ""

# åŒä¸€åˆ†æ”¯åªä¿ç•™æœ€æ–°ä¸€æ¬¡æ„å»º
concurrency:
  group: deploy-ios-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: "ehviewer apple"
  PROJECT: "ehviewer apple.xcodeproj"
  BUNDLE_ID: "Stellatrix.ehviewer-apple"
  TEAM_ID: "HWZEUNLCY6"
  ARCHIVE_PATH: build/EhViewer.xcarchive
  IPA_DIR: build/ipa
  EXPORT_OPTIONS: build/ExportOptions.plist

jobs:
  build-and-deploy:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      # â”€â”€â”€ 0. æ£€å‡ºä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€â”€ 1. ç¯å¢ƒå‡†å¤‡: Xcode ç‰ˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      # â”€â”€â”€ 2. è¯ä¹¦ & æè¿°æ–‡ä»¶æ³¨å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Import certificate & provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # è§£ç è¯ä¹¦å’Œæè¿°æ–‡ä»¶
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision

          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o "$PP_PATH"

          # åˆ›å»ºä¸´æ—¶é’¥åŒ™ä¸²
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥è¯ä¹¦
          security import "$CERTIFICATE_PATH" \
            -P "$P12_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          # å®‰è£…æè¿°æ–‡ä»¶
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< \
            "$(security cms -D -i "$PP_PATH")")
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"$PP_UUID.mobileprovision"

          echo "PP_UUID=$PP_UUID" >> "$GITHUB_ENV"
          echo "âœ… Certificate imported, provisioning profile installed: $PP_UUID"

      # â”€â”€â”€ 3. è§£æ SPM ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resolve Swift packages
        run: |
          cd "ehviewer apple"
          xcodebuild -resolvePackageDependencies \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm_cache"

      # â”€â”€â”€ 4. ç”Ÿæˆ ExportOptions.plist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate ExportOptions.plist
        run: |
          mkdir -p build
          cat > "$EXPORT_OPTIONS" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>HWZEUNLCY6</string>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>Stellatrix.ehviewer-apple</key>
              <string>${PP_UUID}</string>
            </dict>
          </dict>
          </plist>
          PLIST

          # æ›¿æ¢ PP_UUID å ä½ç¬¦
          sed -i '' "s/\${PP_UUID}/$PP_UUID/" "$EXPORT_OPTIONS"
          echo "âœ… ExportOptions.plist generated"
          cat "$EXPORT_OPTIONS"

      # â”€â”€â”€ 5. Archive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Archive
        run: |
          cd "ehviewer apple"
          xcodebuild archive \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "generic/platform=iOS" \
            -archivePath "../$ARCHIVE_PATH" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm_cache" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PP_UUID" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            -allowProvisioningUpdates \
            COMPILER_INDEX_STORE_ENABLE=NO \
            | xcpretty || true

          echo "âœ… Archive complete"
          ls -la "../$ARCHIVE_PATH"

      # â”€â”€â”€ 6. Export IPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist "$EXPORT_OPTIONS" \
            -exportPath "$IPA_DIR" \
            | xcpretty || true

          # é‡å‘½åä¸ºå›ºå®šæ–‡ä»¶å
          IPA_FILE=$(find "$IPA_DIR" -name "*.ipa" | head -1)
          if [ -z "$IPA_FILE" ]; then
            echo "âŒ No IPA file found!"
            exit 1
          fi
          mv "$IPA_FILE" "$IPA_DIR/EhViewer.ipa"

          echo "âœ… IPA exported"
          ls -lh "$IPA_DIR/EhViewer.ipa"

      # â”€â”€â”€ 7. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract version info
        id: version
        run: |
          PLIST_PATH="$ARCHIVE_PATH/Products/Applications/ehviewer apple.app/Info.plist"
          if [ ! -f "$PLIST_PATH" ]; then
            # fallback: ä»é¡¹ç›®è¯»å–
            VERSION="1.0.0"
            BUILD_NUM="1"
          else
            VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$PLIST_PATH")
            BUILD_NUM=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST_PATH")
          fi
          DATE=$(date +%Y%m%d)
          TITLE="EhViewer v${VERSION} (${BUILD_NUM}) - ${DATE}"
          if [ -n "${{ github.event.inputs.build_note }}" ]; then
            TITLE="${TITLE} - ${{ github.event.inputs.build_note }}"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build=$BUILD_NUM" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ $TITLE"

      # â”€â”€â”€ 8. ç”Ÿæˆ manifest.plist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate manifest.plist
        run: |
          cat > "$IPA_DIR/manifest.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
            "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>items</key>
            <array>
              <dict>
                <key>assets</key>
                <array>
                  <dict>
                    <key>kind</key>
                    <string>software-package</string>
                    <key>url</key>
                    <string>https://ios.stellatrix.icu/EhViewer.ipa</string>
                  </dict>
                </array>
                <key>metadata</key>
                <dict>
                  <key>bundle-identifier</key>
                  <string>${{ env.BUNDLE_ID }}</string>
                  <key>bundle-version</key>
                  <string>${{ steps.version.outputs.version }}</string>
                  <key>kind</key>
                  <string>software</string>
                  <key>title</key>
                  <string>${{ steps.version.outputs.title }}</string>
                </dict>
              </dict>
            </array>
          </dict>
          </plist>
          EOF

          echo "âœ… manifest.plist generated"
          cat "$IPA_DIR/manifest.plist"

      # â”€â”€â”€ 9. éƒ¨ç½²åˆ° Stellatrix æœåŠ¡å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy to Stellatrix
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          source: "build/ipa/EhViewer.ipa,build/ipa/manifest.plist"
          target: "/var/www/html/ios/"
          strip_components: 2

      # â”€â”€â”€ 10. æœåŠ¡å™¨åå¤„ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post-deploy setup
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            cd /var/www/html/ios/
            chmod 644 EhViewer.ipa manifest.plist
            echo "$(date): Deployed ${{ steps.version.outputs.title }}" >> deploy.log
            echo "âœ… Files deployed and permissions set"
            ls -lh EhViewer.ipa manifest.plist

      # â”€â”€â”€ 11. æ¸…ç†é’¥åŒ™ä¸² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

      # â”€â”€â”€ 12. æ„å»ºæ‘˜è¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… æ„å»º & éƒ¨ç½²æˆåŠŸ"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  ç‰ˆæœ¬: ${{ steps.version.outputs.title }}"
          echo "  æäº¤: ${{ github.sha }}"
          echo ""
          echo "  ğŸ“² å®‰è£…é“¾æ¥:"
          echo "  https://ios.stellatrix.icu"
          echo ""
          echo "  ğŸ“¦ ç›´æ¥å®‰è£… (Safari æ‰“å¼€):"
          echo "  itms-services://?action=download-manifest&url=https://ios.stellatrix.icu/manifest.plist"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # GitHub Actions Job Summary
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## ğŸ“± EhViewer iOS éƒ¨ç½²æˆåŠŸ

          | é¡¹ç›® | å€¼ |
          |------|-----|
          | **ç‰ˆæœ¬** | ${{ steps.version.outputs.version }} (${{ steps.version.outputs.build }}) |
          | **æ—¥æœŸ** | ${{ steps.version.outputs.date }} |
          | **æäº¤** | \`${{ github.sha }}\` |

          ### å®‰è£…æ–¹å¼
          Safari æ‰“å¼€: \`itms-services://?action=download-manifest&url=https://ios.stellatrix.icu/manifest.plist\`

          æˆ–è®¿é—®: [https://ios.stellatrix.icu](https://ios.stellatrix.icu)
          EOF
